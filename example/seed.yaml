name: nameApp
version: 0.0.1
log: false
vars:
  name: Test App
  environment: staging
  port: 4000
  branch: main
  projectDir: /Users/tufikchediak/mega/server/projects/cloudbit/repositories/continuous-seed/example
tasks:
  configServer: &configServer
    - echo: ${DATETIME} - configServer
    - cmd: kill -9 $(lsof -t -i tcp:${port})
    - cmd: |
        echo '
          export const config = {
            name:"${name}",
            environment:"${environment}",
            port:${port}
          }
        ' > ${projectDir}/continuous-seed-test/config.js
    - cmd:
        app: npm
        args: install
        workingDirectory: ${projectDir}/continuous-seed-test/
    - cmd:
        app: npm
        args: start
        workingDirectory: ${projectDir}/continuous-seed-test/
        background: true
jobs:
  - cloneRepo:
      - echo: ${DATETIME} - cloneRepo
      - cmd: git clone -b ${branch} https://github.com/cloudbit-interactive/continuous-seed-test.git ${projectDir}/continuous-seed-test
      - configServer: *configServer
  - checkUpdates:
      - echo: ${DATETIME} - checkUpdates
      - loop:
          sleepTime: 10000
          jobs:
            - cmd: git -C ${projectDir}/continuous-seed-test reset --hard
            - cmd: git -C ${projectDir}/continuous-seed-test pull
            - if:
                type: contain!
                value: Already up to date
                jobs:
                  - configServer: *configServer
