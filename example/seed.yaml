name: nameApp
version: 0.0.1
log: false
vars:
  name: Test App
  environment: staging
  port: 4000
  projectDir: /Users/tufikchediak/mega/server/projects/cloudbit/repositories/continuous-seed/example
tasks:
  updateServer: &updateServer
    - echo: ${DATETIME} - updateServer
    - cmd: kill -9 $(lsof -t -i:${port})
    - cmd:
        app: killall
        args: node
    - cmd: |
        echo '
          export const config = {
            name:"${name}",
            environment:"${environment}",
            port:${port}
          }
        ' > ${projectDir}/continuous-seed-test/config.js
    - cmd:
        app: npm
        args: install
        workingDirectory: ${projectDir}/continuous-seed-test/
    - cmd:
        app: node
        args: ${projectDir}/continuous-seed-test/src/index.js &> log.log
        workingDirectory: ${projectDir}/continuous-seed-test/
        background: true
jobs:
  - cloneRepo:
      - echo: ${DATETIME} - cloneRepo
      - cmd: git clone -b main https://github.com/cloudbit-interactive/continuous-seed-test.git ${projectDir}/continuous-seed-test
      - updateServer: *updateServer
  - checkUpdates:
      - echo: ${DATETIME} - checkUpdates
      - loop:
          sleepTime: 5000
          jobs:
            - cmd: git -C ${projectDir}/continuous-seed-test reset --hard
            - cmd: git -C ${projectDir}/continuous-seed-test pull
            - echo: ${OUTPUT}
            - if:
                type: contain!
                value: Already up to date
                jobs:
                  - updateServer: *updateServer
