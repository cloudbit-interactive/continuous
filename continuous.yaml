name: nameApp
version: 0.0.1
vars:
  domain: localhost
  port: 4000
  databaseHost: localhost
  databasePort: 3306
  databaseName: mha
  databaseUser: root
  databasePass: root
  workDir: /var/mhaServer
  serviceDir: ./fakeServicesDir
jobs:
  - createService:
    - cmd: if [ -f ${serviceDir}/continuous.service ] ; then echo 1 ; else echo 0 ; fi
    - if:
      type: !contain
      value: 0
      jobs:
        - cmd: touch continuous.service
        - cmd: |
            echo '
              [Unit]
              Description=instance to serve api
              After=network.target
              [Service]
              User=root
              Group=root
              ExecStart=${workDir}/continuous
              [Install]
              WantedBy=multi-user.target
            ' > continuous.service
        - cmd: mv continuous.service ${fakeServicesDir}/continuous.service
        - cmd: sudo systemctl daemon-reload;
        - cmd: sudo systemctl enable continuous.service
        - cmd: sudo systemctl start continuous
        - stop
  - cloneRepo:
    - cmd: git clone -b master https://tufik_chediak:ATBBfTrSHKGTHDQMNwWBLsYBVAnaC774C627@bitbucket.org/refinedrisk/risk-mental-health-app.git ${$workdir}
  - checkUpdates:
    - loop:
      repeat: 2                               # remove to infinity loop
      sleepTIme: 10000                        # milliseconds
      jobs:
        - updateDB:

        - updateServer:
          - cmd: git -C $workDir pull
          - if:
            type: !contain
            value: Already up to date
            jobs:
              - cmd: sudo systemctl stop continuous
              - replace:
                file: ${workDir}/server/config.js
                match: databaseHost:'localhost'
                to: databaseHost:'${databaseHost}'
              - replace: --file=${workDir}/server/config.js --match=databasePort:'3306' --to=databasePort:'${databasePort}'
              - replace: --file=${workDir}/server/config.js --match=databaseName:'mha' --to=databaseName:'${databaseName}'
              - replace: --file=${workDir}/server/config.js --match=databaseUser:'root' --to=databaseUser:'${databaseUser}'
              - replace: --file=${workDir}/server/config.js --match=databasePass:'root' --to=databasePass:'${databasePass}'
              - replace: --file=${workDir}/server/config.js --match=databaseHost:'localhost' --to=databaseHost:'${databaseHost}'
              - cmd: sudo systemctl start continuous
